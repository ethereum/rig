---
title: "Late finality leak, epoch 15614 onwards"
author:
- name: Barnab√© Monnot
  url: https://twitter.com/barnabemonnot
  affiliation: Robust Incentives Group, Ethereum Foundation
  affiliation_url: https://github.com/ethereum/rig
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    toc: yes
    toc_depth: 3
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
description: |
  Longing for epoch 15614 and finality
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(patchwork)
library(rmarkdown)

source(here::here("notebooks/lib.R"))

options(digits=10)
options(scipen = 999) 

# Make the plots a bit less pixellated
knitr::opts_chunk$set(dpi = 300)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# A minimal theme I like
newtheme <- theme_grey() + theme(
  axis.text = element_text(size = 9),
  axis.title = element_text(size = 12),
  axis.line = element_line(colour = "#000000"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_blank(),
  legend.title = element_text(size = 12),
  legend.text = element_text(size = 10),
  legend.box.background = element_blank(),
  legend.key = element_blank(),
  strip.text.x = element_text(size = 10),
  strip.background = element_rect(fill = "white")
)
theme_set(newtheme)

myred <- "#F05431"
myyellow <- "#FED152"
mygreen <- "#BFCE80"

slots_per_epoch <- 32
```

```{r eval=FALSE, warning=TRUE}
all_bxs <- fread(here::here("rds_data/all_bxs.csv"))
extra_bxs_ats <- add_bxs_and_ats(20480, 21000)

list(all_bxs, extra_bxs_ats$blocks %>%
       mutate(declared_client = find_client(graffiti))) %>%
  rbindlist() %>%
  fwrite(here::here("rds_data/all_bxs.csv"))

extra_bxs_ats$attestations %>% fwrite(here::here("rds_data/all_ats_post_20481.csv"))
```

```{r eval=FALSE}
committees <- add_committees(20481, 21000)
committees %>% fwrite(here::here("rds_data/committees_post_20481.csv"))
```

```{r}
all_bxs <- fread(here::here("rds_data/all_bxs.csv"))
all_ats <- fread(here::here("rds_data/all_ats_post_20481.csv"))
committees <- fread(here::here("rds_data/committees_post_20481.csv"))
```

```{r cache=TRUE}
# Either get the last declared client by validator
client_per_validator <- all_bxs %>%
  .[, .SD[which.max(slot)], by=proposer_index, .SDcols = c("slot", "declared_client")]
fwrite(client_per_validator, here::here("rds_data/client_per_validator.csv"))

# Or get the most used declared client by validator
# client_per_validator <- all_bxs %>%
#   .[, .(client_count = .N), by=.(proposer_index, declared_client)] %>%
#   .[, .SD[which.max(client_count)], by=proposer_index]
```

```{r}
plot_grid <- function(start_epoch, end_epoch, committees) {
  attestation_grid <- all_ats %>%
    .[att_slot >= start_epoch * slots_per_epoch & att_slot < (end_epoch + 1) * slots_per_epoch,
      .(att_slot, committee_index, attesting_indices)] %>%
    get_exploded_ats() %>%
    merge(committees,
          by.x = c("att_slot", "committee_index", "index_in_committee"),
          by.y = c("att_slot", "committee_index", "index_in_committee")) %>%
    .[,.(att_slot, epoch=att_slot %/% slots_per_epoch, validator_index, attested)] %>%
    merge(client_per_validator %>%
            .[, .(proposer_index, declared_client)],
          by.x = c("validator_index"), by.y = c("proposer_index")) %>%
    unique()
  
  l = list()

  for (client in c("prysm", "lighthouse", "nimbus", "teku")) {
    attestation_grid_per_client <- attestation_grid %>%
      .[epoch <= end_epoch & epoch >= start_epoch & declared_client == client] %>%
      mutate(validator_index = as.factor(validator_index),
             attested = as_factor(attested))
    
    p <- attestation_grid_per_client %>%
      ggplot() +
      geom_tile(aes(x = epoch, y = validator_index, fill = attested)) +
      scale_fill_manual(values = c(mygreen), guide=FALSE) +
      scale_x_continuous(expand = c(0, 0)) +
      facet_wrap(vars(declared_client)) +
      theme(axis.text.y=element_blank(),
            axis.ticks.y=element_blank(),
            panel.background=element_rect(fill=myred, colour=myred),
            axis.title.x = element_text(size = 7),
            axis.title.y = element_text(size = 7),
            axis.text.x = element_text(size = 7),
            strip.text = element_text(size = 8))
    
    l[[client]] <- p
  }
  
  l[["prysm"]] | l[["lighthouse"]] | l[["nimbus"]] | l[["teku"]]
}
```

```{r}
start_epoch <- 20480
end_epoch <- 20599
```

### Epoch `r start_epoch` to `r end_epoch`

A moment in time, between `r get_date_from_epoch(start_epoch)` and `r get_date_from_epoch(end_epoch + 1)`.

```{r, layout="l-screen", fig.height=2}
plot_grid(start_epoch, end_epoch, committees)
```

```{r}
start_epoch <- 20600
end_epoch <- 20699
```

### Epoch `r start_epoch` to `r end_epoch`

A moment in time, between `r get_date_from_epoch(start_epoch)` and `r get_date_from_epoch(end_epoch + 1)`.

```{r, layout="l-screen", fig.height=2}
plot_grid(start_epoch, end_epoch, committees)
```

```{r}
start_epoch <- 20700
end_epoch <- 20799
```

### Epoch `r start_epoch` to `r end_epoch`

A moment in time, between `r get_date_from_epoch(start_epoch)` and `r get_date_from_epoch(end_epoch + 1)`.

```{r, layout="l-screen", fig.height=2}
plot_grid(start_epoch, end_epoch, committees)
```

```{r}
start_epoch <- 20800
end_epoch <- 20899
```

### Epoch `r start_epoch` to `r end_epoch`

A moment in time, between `r get_date_from_epoch(start_epoch)` and `r get_date_from_epoch(end_epoch + 1)`.

```{r, layout="l-screen", fig.height=2}
plot_grid(start_epoch, end_epoch, committees)
```

```{r}
start_epoch <- 20900
end_epoch <- 20999
```

### Epoch `r start_epoch` to `r end_epoch`

A moment in time, between `r get_date_from_epoch(start_epoch)` and `r get_date_from_epoch(end_epoch + 1)`.

```{r, layout="l-screen", fig.height=2}
plot_grid(start_epoch, end_epoch, committees)
```
